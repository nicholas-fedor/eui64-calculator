name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch: {}
  workflow_call: {}

permissions:
  contents: write
  packages: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@faf52423ec0d44c58f68e83b614bfcd99dded66f
        with:
          go-version-file: "go.mod"

      - name: Cache Go modules
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: "${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}"
          restore-keys: "${{ runner.os }}-go-"

      - name: Install templ
        run: go install github.com/a-h/templ/cmd/templ@latest

      - name: Install dependencies
        run: go mod download

      - name: Generate templates
        run: go generate ./...

      - name: Build static-gen
        run: go build -o static-gen ./build/gh-pages/static-gen/main.go

      - name: Create dist/static directory if it doesn't exist
        run: mkdir -p ./dist/static

      - name: Copy wasm_exec.js from GOROOT/lib/wasm or download it
        run: |
          echo "Copying wasm_exec.js..."
          WASM_EXEC_SRC="$(go env GOROOT)/lib/wasm/wasm_exec.js"
          WASM_EXEC_DEST="./dist/static/wasm_exec.js"
          WASM_EXEC_URL="https://raw.githubusercontent.com/golang/go/master/lib/wasm/wasm_exec.js"

          if [ -f "$WASM_EXEC_SRC" ]; then
              cp "$WASM_EXEC_SRC" "$WASM_EXEC_DEST"
              echo "Copied wasm_exec.js to ./dist/static/"
          else
              echo "wasm_exec.js not found at $WASM_EXEC_SRC. Downloading from $WASM_EXEC_URL..."
              if ! curl -L -o "$WASM_EXEC_DEST" "$WASM_EXEC_URL"; then
                  echo "Error: Failed to download wasm_exec.js from $WASM_EXEC_URL" >&2
                  exit 1
              fi
              echo "Downloaded wasm_exec.js to ./dist/static/"
          fi

      - name: Copy static assets
        run: |
          cp cmd/server/static/styles.css dist/static/
          cp cmd/server/static/favicon.ico dist/static/
          cp build/gh-pages/static/scripts.js dist/static/

      - name: Build WASM
        run: GOOS=js GOARCH=wasm go build -o dist/static/main.wasm ./build/gh-pages/wasm/main.go

      - name: Generate index.html
        run: ./static-gen

      - name: Add nojekyll dotfile
        run: touch dist/static/.nojekyll

      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@4a3abc783e1a24aeb44c16e869ad83caf6b4cc23 # v4
        with:
          branch: gh-pages
          folder: dist/static
